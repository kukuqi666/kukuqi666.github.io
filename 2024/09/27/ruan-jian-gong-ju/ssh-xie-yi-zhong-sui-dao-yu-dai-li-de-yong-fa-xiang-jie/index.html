<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="SSH协议中隧道与代理的用法详解, 如梦初醒, kukuqi666">
    <meta name="description" content="从来没有真正的绝境，只有心灵的迷途">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SSH协议中隧道与代理的用法详解 | 如梦初醒</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="如梦初醒" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">如梦初醒</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle-o" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">如梦初醒</div>
        <div class="logo-desc">
            
            从来没有真正的绝境，只有心灵的迷途
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle-o"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/kukuqi666/kukuqi666.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Home page
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/kukuqi666/kukuqi666.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Home page" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SSH协议中隧道与代理的用法详解</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ssh-socks-%E4%BB%A3%E7%90%86-%E5%A4%9A%E7%BA%A7%E4%BB%A3%E7%90%86-%E9%9A%A7%E9%81%93/">
                                <span class="chip bg-color">ssh socks 代理 多级代理 隧道</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="post-category">
                                软件工具
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-09-27
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    13 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        <link rel="stylesheet" href="/libs/prism/prism.css">
        <!-- 代码块折行 -->
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>SSH 协议是 Linux 系统中使用较为频繁的协议之一，通常用于远程管理主机或服务器，默认使用 22 端口，可类比 Windows 系统中的 <code>telnet</code>（23 端口），这里要介绍的是 ssh 除了远程连接外的另一强大特性，即隧道加密与多种场景下代理功能的实现。</p>
<h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><p>为了理解更轻松，最大程度上简化网络拓扑，后续都只用两台机器做测试，IP 与主机名对应关系如下；更复杂的网络结构和多接口场景可举一反三延申，要用作某些特殊用途，则自行<strong>YY</strong>。</p>
<pre class="line-numbers language-none"><code class="language-none">192.168.111.128  --&gt;  Kali
192.168.111.131  --&gt;  Centos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在验证 IP 地址和多级代理的场景时，会额外用到网关机器：<code>192.168.111.1</code>。</p>
<p>然后再多了解一下三个 ssh 的命令行参数，后面会用到：</p>
<pre class="line-numbers language-none"><code class="language-none">-N    建立连接后不远程执行命令，也没有交互shell，通常用于端口转发的场景。
-f    建立连接后会在后台运行进程，不占用前台窗口。
-c    传输数据时对数据进行压缩，压缩算法和 gzip 的一样，但不适用于高速网络环境，会降低连接速度。
-v    打印更详细的连接过程信息。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="本地转发（-L）"><a href="#本地转发（-L）" class="headerlink" title="本地转发（-L）"></a>本地转发（-L）</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>本地转发即使用 <code>ssh -L</code> 参数，先看一下官方解释（<code>man ssh</code>）：</p>
<pre class="line-numbers language-none"><code class="language-none">-L [bind_address:]port:host:hostport
-L [bind_address:]port:remote_socket
-L local_socket:host:hostport
-L local_socket:remote_socket
        Specifies that connections to the given TCP port or Unix socket on the local (client) host are to be
        forwarded to the given host and port, or Unix socket, on the remote side.  This works by allocating a
        socket to listen to either a TCP port on the local side, optionally bound to the specified bind_address,
        or to a Unix socket.  Whenever a connection is made to the local port or socket, the connection is for‐
        warded over the secure channel, and a connection is made to either host port hostport, or the Unix
        socket remote_socket, from the remote machine.

        Port forwardings can also be specified in the configuration file.  Only the superuser can forward privi‐
        leged ports.  IPv6 addresses can be specified by enclosing the address in square brackets.

        By default, the local port is bound in accordance with the GatewayPorts setting.  However, an explicit
        bind_address may be used to bind the connection to a specific address.  The bind_address of “localhost”
        indicates that the listening port be bound for local use only, while an empty address or ‘*’ indicates
        that the port should be available from all interfaces.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>翻译成人话，通俗讲就是，使用该参数执行 ssh 连接后，会在<strong>本机开启</strong>一个指定监听端口1，然后绑定到远程机器的指定接口（IP）的指定端口2，用另一个程序再访问本机的指定端口1，流量就会<strong>转发</strong>到远程机器的指定端口2，相当于直接访问远程机器的端口2；可以简单的理解为 “流量从<strong>本地转发</strong>到远程机器”。</p>
<p>参数值（<code>[bind_address:]port:host:hostport</code>）也有规律，从左到右写是本地到远程的顺序：本地地址（<code>bind_address]</code>）的端口（<code>port</code>）转发到远程地址（<code>host</code>）的端口（<code>hostport</code>），本地接口地址可省略，默认为 <code>127.0.0.1</code>。除了接口和端口也可以使用 <code>Unix socket</code> 建立连接，把对应的位置换成 socket 地址即可。</p>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><p>上面的转发流程有点绕，用实验来理解下实际效果，假设场景为 <strong>Kali</strong>（<code>192.168.111.128</code>）去连接 <strong>Centos</strong>（<code>192.168.111.131</code>）；那么首先确保 <strong>Centos</strong> 开启 22 端口，然后用 python 给它在 <code>8000</code> 端口开启一个简单的 <code>http</code> 服务：<br><img src="https://img-blog.csdnimg.cn/e5efe8b0f91b4fefac7532ae89b8bd01.png" alt="centos-http-server"></p>
<p>试着先本地访问下（<strong>Centos</strong> 具有第二个接口：<code>192.168.122.1</code>）：<br><img src="https://img-blog.csdnimg.cn/6904b332e0b04639986382d09006d30a.png" alt="centos-http-curl"></p>
<p>ok 没问题，接着去另一台机器 <strong>Kali</strong>（<code>192.168.111.128</code>） 上先测试连一下 <strong>Centos</strong> 的 ssh：<br><img src="https://img-blog.csdnimg.cn/d15e5d35cd414e6aad4a3fc366b281ec.png" alt="kali-ssh-centos"></p>
<p>证明连接是通的，接下来直接在 <strong>Kali</strong> 上使用本地转发连接 <strong>Centos</strong>（为了方便已提前给两台机器配置了 ssh 公钥连接，避免输入密码），执行参数为：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh -NL 1080:192.168.122.1:8000 root@192.168.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后执行后会在 <strong>Kali</strong> 本地监听 <code>1080</code>，再用 <code>curl</code> 访问一下这个端口，返回数据就是 <strong>Centos</strong> 的 <code>192.168.122.1</code> 接口上的 <code>8000</code> 端口所对应的内容：<br><img src="https://img-blog.csdnimg.cn/7da29b21bb0f42e68704fabb0138a7bd.png" alt="kali-local-curl-1080"></p>
<p>Centos 这边也记录到了相应的连接日志，本地转发<strong>成功</strong>：<br><img src="https://img-blog.csdnimg.cn/78863e76116d40659a599214162137da.png" alt="centos-http-log"></p>
<h2 id="远程转发（-R）"><a href="#远程转发（-R）" class="headerlink" title="远程转发（-R）"></a>远程转发（-R）</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>远程转发的执行参数是 <code>ssh -R</code>，官方的解释是：</p>
<pre class="line-numbers language-none"><code class="language-none">-R [bind_address:]port:host:hostport
-R [bind_address:]port:local_socket
-R remote_socket:host:hostport
-R remote_socket:local_socket
-R [bind_address:]port
        Specifies that connections to the given TCP port or Unix socket on the remote (server) host are to be
        forwarded to the local side.

        This works by allocating a socket to listen to either a TCP port or to a Unix socket on the remote side.
        Whenever a connection is made to this port or Unix socket, the connection is forwarded over the secure
        channel, and a connection is made from the local machine to either an explicit destination specified by
        host port hostport, or local_socket, or, if no explicit destination was specified, ssh will act as a
        SOCKS 4&#x2F;5 proxy and forward connections to the destinations requested by the remote SOCKS client.

        Port forwardings can also be specified in the configuration file.  Privileged ports can be forwarded
        only when logging in as root on the remote machine.  IPv6 addresses can be specified by enclosing the
        address in square brackets.

        By default, TCP listening sockets on the server will be bound to the loopback interface only.  This may
        be overridden by specifying a bind_address.  An empty bind_address, or the address ‘*’, indicates that
        the remote socket should listen on all interfaces.  Specifying a remote bind_address will only succeed
        if the server&#39;s GatewayPorts option is enabled (see sshd_config(5)).

        If the port argument is ‘0’, the listen port will be dynamically allocated on the server and reported to
        the client at run time.  When used together with -O forward, the allocated port will be printed to the
        standard output.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通俗讲就是，执行远程转发命令后，会在<strong>远程机器开启</strong>监听一个指定端口1，绑定到本地的指定端口2，所有访问远程机器端口1 的流量都会被<strong>转发</strong>到本地的端口2 上，相当于直接访问本地的端口2，也可以简单的理解为 “流量从<strong>远程转发</strong>到本地机器”；</p>
<p>可以注意到这里的转发流向其实是和上面的<strong>本地转发</strong>是反的，所以参数值（<code>[bind_address:]port:host:hostport</code>）的规律也反了过来，从左到右写是：远程机器的接口（<code>[bind_address]</code>）上的端口（<code>port</code>）转发到本地接口（<code>host</code>）的端口（<code>hostport</code>）上去。远程接口地址（IP）可以省略，默认 <code>127.0.0.1</code>，<code>socket</code> 连接同理。</p>
<p>这里有个<strong>值得注意</strong>的地方，可以看到参数值那块，相比于前面的本地转发多了个 <code>[bind_address:]port</code> 值，也就是说同时省略了本地接口地址和端口值，远程接口也可按需省略，相当于可以只写一个远程端口值，这样其实会建立一个<strong>反向的 socks5 代理</strong>，即远程机器的那个端口可以被当成一个 <code>socks4</code> 或 <code>socks5</code> 代理端口，代理流量都会被引导至本地机器，这个后面也有对应实验验证。</p>
<h3 id="实验-1"><a href="#实验-1" class="headerlink" title="实验"></a>实验</h3><p>下面同样使用 <strong>Kali</strong>（<code>192.168.111.128</code>）通过远程转发去连接 <strong>Centos</strong>（<code>192.168.111.131</code>），不过这次是在 <strong>Kali</strong> 上用 python 启一个简单的 <code>http</code> 服务：<br><img src="https://img-blog.csdnimg.cn/2d752bb9fe444d79aa58823a645126b1.png" alt="kali-http-and-curl"></p>
<p>本地连接没问题，接下来在 <strong>Kali</strong> 上开启远程转发，参数为：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh -NR 1080:127.0.0.1:8000 root@192.168.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://img-blog.csdnimg.cn/2459194c35c640ebafc4d6bed96ad8c4.png" alt="kali-http-and-remote"></p>
<p>这会在远程机器（<strong>Centos</strong>, <code>192.168.111.131</code>）上开启一个新的监听端口 <code>1080</code>，再使用 <code>curl</code> 对其访问，就会得到 <strong>Kali</strong>（<code>192.168.111.128</code>）上端口 <code>8000</code> 的返回内容：<br><img src="https://img-blog.csdnimg.cn/e4d319fdbfb446b4915879c447024b0c.png" alt="centos-remote-1080"></p>
<p>Kali 这边也有了相应的访问记录，至此远程转发<strong>成功</strong>：<br><img src="https://img-blog.csdnimg.cn/54a9843f127b47509f19a0a89bb16b34.png" alt="kali-http-8000-log"></p>
<h4 id="反向-socks-代理"><a href="#反向-socks-代理" class="headerlink" title="反向 socks 代理"></a>反向 socks 代理</h4><p>然后测试 <code>-R</code> 参数值只指定一个远程端口的效果，前面讲这会让本地机器成为一台 <code>socks</code> 代理服务器，下面为了测试代理效果，就需要网关机器（<code>192.168.111.1</code>）上场了，在网关上启一个简单的 <code>php</code> 服务，以获取访问者的真实 IP 地址，代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">echo</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token constant">PHP_EOL</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>访问路径是：<code>http://192.168.111.1/get-ip.php</code>，先分别用 <strong>Kali</strong> 和 <strong>Centos</strong> 访问试下：<br><img src="https://img-blog.csdnimg.cn/a1c18d5416564710a603a9e942523172.png" alt="kali-get-ip"></p>
<p><img src="https://img-blog.csdnimg.cn/0c1080286e314d358dcb6584e1867365.png" alt="centos-get-ip"></p>
<p>ok，IP 是对的，然后在 <strong>Kali</strong>（<code>192.168.111.128</code>）上启动反向 socks 代理服务：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh -NR 1080 root@192.168.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://img-blog.csdnimg.cn/cc6020eaf4f14532a054751042db7f78.png" alt="kali-rev-socks"></p>
<p>去 <strong>Centos</strong>（<code>192.168.111.131</code>）上访问一下看看代理（使用 <code>curl</code> 的 <code>-x</code> 参数指定代理服务器）效果：<br><img src="https://img-blog.csdnimg.cn/90412805af2246bfbaf45611cccb629a.png" alt="centos-socks-curl"></p>
<p>至此反向 socks 代理<strong>成功</strong>。</p>
<h4 id="远程接口地址问题"><a href="#远程接口地址问题" class="headerlink" title="远程接口地址问题"></a>远程接口地址问题</h4><p>在实际使用远程转发的时候，可能会遇到一个<strong>小坑</strong>，就是 <code>-R</code> 的参数值虽然可以任意指定远程机器的接口地址，但实际上 ssh <strong>默认</strong>都只会在 <code>127.0.0.1</code> 接口地址上开监听端口，也就是说假如这台远程机器是台公网服务器的话，新监听的端口是没法在公网上访问到的，只能这台机器本地访问，这是一个 <code>sshd</code> 的<strong>默认配置</strong>导致的，它一般在 <code>/etc/ssh/sshd_config</code> 文件中，**<code>GatewayPorts</code>** 这个配置项，默认是 <code>no</code>，改成 <code>yes</code> 即可，如果没有这一行就手动添加：<br><img src="https://img-blog.csdnimg.cn/96b7ab65497347ccb8396a0c17da893f.png" alt="centos-sshd-gatewayports"></p>
<p>然后重启 <code>sshd</code> 服务，再用远程转发连接时就会在<strong>所有接口</strong>（即 <code>0.0.0.0</code>）上监听新端口了，但这样也<strong>只能</strong>在所有接口上开启端口了，无论连接方如何设置远程接口，所以需斟酌使用。<br><img src="https://img-blog.csdnimg.cn/75b3901f650a4673b1314743b0d53d9a.png" alt="centos-gatewayports-yes"></p>
<h2 id="动态转发（-D）"><a href="#动态转发（-D）" class="headerlink" title="动态转发（-D）"></a>动态转发（-D）</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>动态转发的执行参数是 <code>ssh -D</code>，官方解释是：</p>
<pre class="line-numbers language-none"><code class="language-none">-D [bind_address:]port
        Specifies a local “dynamic” application-level port forwarding.  This works by allocating a socket to
        listen to port on the local side, optionally bound to the specified bind_address.  Whenever a connection
        is made to this port, the connection is forwarded over the secure channel, and the application protocol
        is then used to determine where to connect to from the remote machine.  Currently the SOCKS4 and SOCKS5
        protocols are supported, and ssh will act as a SOCKS server.  Only root can forward privileged ports.
        Dynamic port forwardings can also be specified in the configuration file.

        IPv6 addresses can be specified by enclosing the address in square brackets.  Only the superuser can
        forward privileged ports.  By default, the local port is bound in accordance with the GatewayPorts set‐
        ting.  However, an explicit bind_address may be used to bind the connection to a specific address.  The
        bind_address of “localhost” indicates that the listening port be bound for local use only, while an
        empty address or ‘*’ indicates that the port should be available from all interfaces.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这应该是实际使用中较多的一种用途，即 socks 代理，动态转发是在<strong>本地</strong>监听一个指定端口，应用程序将 socks 代理端口设置为这个端口后，任何连接流量都会通过这个端口，经由 ssh 隧道转发到远程机器代为发送，由于不再受限于连接端和被连接端的端口与接口，所以称为<strong>动态</strong>。</p>
<p>参数值（<code>[bind_address:]port</code>）为要在本地机器监听的接口地址与端口，不写接口地址则默认为 <code>127.0.0.1</code>，在所有接口监听则写 <code>0.0.0.0</code>。</p>
<h3 id="实验-2"><a href="#实验-2" class="headerlink" title="实验"></a>实验</h3><p>还是在 <strong>Kali</strong>（<code>192.168.111.128</code>）上执行操作，监听本地 <code>1080</code> 端口，将 <strong>Centos</strong>（<code>192.168.111.131</code>）作为 socks 代理服务器：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh -ND 1080 root@192.168.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://img-blog.csdnimg.cn/17a5eb5e95694253baddbf2bf719acc3.png" alt="kali-dynamic-socks"></p>
<p>尝试用 <code>curl</code> 测试代理效果，可以看到 socks5 代理已生效，IP 地址为 <strong>Centos</strong>（<code>192.168.111.131</code>）的：<br><img src="https://img-blog.csdnimg.cn/1af48a1714f04ea0a293dc1e471493ef.png" alt="kali-dynamic-get-ip"></p>
<p><strong>Kali</strong> 访问 <strong>Centos</strong> 的其他接口（<code>192.168.122.1</code>）的 http 服务（<code>8000</code> 端口）也没问题：<br><img src="https://img-blog.csdnimg.cn/b9ebdbd78cd44dba91f383cf410b9acc.png" alt="kali-socks-centos-python"><br><img src="https://img-blog.csdnimg.cn/6bc83c262054402ea7a91186c4db5156.png" alt="centos-dynamic-socks-http-log"></p>
<h2 id="多级代理（-J）"><a href="#多级代理（-J）" class="headerlink" title="多级代理（-J）"></a>多级代理（-J）</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>实现多级代理需要用到 <code>ssh -J</code> 参数，即设置 <code>Jump host</code>，可理解为跳板，官方解释为：</p>
<pre class="line-numbers language-none"><code class="language-none">-J destination
        Connect to the target host by first making a ssh connection to the jump host described by destination
        and then establishing a TCP forwarding to the ultimate destination from there.  Multiple jump hops may
        be specified separated by comma characters.  This is a shortcut to specify a ProxyJump configuration di‐
        rective.  Note that configuration directives supplied on the command-line generally apply to the desti‐
        nation host and not any specified jump hosts.  Use ~&#x2F;.ssh&#x2F;config to specify configuration for jump
        hosts.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大意就是连接 <code>ssh</code> 的过程中，可以指定（多个）<strong>跳板机</strong>，实现流量的一级一级转发，每一级跳板的系统都只有上一级的访问记录，达到一定的<strong>隐匿</strong>作用。参数值 <code>destination</code> 的语法与普通 <code>ssh</code> 连接对象的语法一致，指定多个跳板则将多个节点值以<strong>逗号</strong>分隔。</p>
<h3 id="实验-3"><a href="#实验-3" class="headerlink" title="实验"></a>实验</h3><p>为了呈现多级节点的效果，这里需再次用到网关机器（<code>192.168.111.1</code>），用其通过 <code>ssh</code> 连接 <strong>Centos</strong>（<code>192.168.111.131</code>），并以 <strong>Kali</strong>（<code>192.168.111.128</code>）作为跳板机，直接在网关上执行：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh root@192.168.111.131 -J root@192.168.111.128<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到最终连接到的 <strong>Centos</strong> 机器的访问记录是跳板机 <strong>Kali</strong> 的 IP 地址：<br><img src="https://img-blog.csdnimg.cn/b55b4aaa34604127903664110a7653eb.png" alt="gateway-jump-centos"></p>
<p>再测试一下指定多个跳板：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssh root@192.168.111.131 -J root@192.168.111.128,root@192.168.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://img-blog.csdnimg.cn/efb3b65892684e0b8e6b109b70e73a00.png" alt="gateway-multi-jump"></p>
<p>这里为了简化网络拓扑，所以把 Centos 自身也设置为一个跳板，那么经过的两个跳转节点就是 <code>.128</code> 和 <code>.131</code>，整个流量流转过程可以简化为：</p>
<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">*.111.1  --&gt;  *.111.128  --&gt;  *.111.131  --&gt;  *.111.131<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将 <code>-J</code> 参数与前面提到的几种转发与代理参数结合，就实现了<strong>多级代理</strong>功能。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">kukuqi666</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kukuqi666.github.io/2024/09/27/ruan-jian-gong-ju/ssh-xie-yi-zhong-sui-dao-yu-dai-li-de-yong-fa-xiang-jie/">https://kukuqi666.github.io/2024/09/27/ruan-jian-gong-ju/ssh-xie-yi-zhong-sui-dao-yu-dai-li-de-yong-fa-xiang-jie/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">kukuqi666</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/ssh-socks-%E4%BB%A3%E7%90%86-%E5%A4%9A%E7%BA%A7%E4%BB%A3%E7%90%86-%E9%9A%A7%E9%81%93/">
                                    <span class="chip bg-color">ssh socks 代理 多级代理 隧道</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    
        <style>
    .mvaline-card {
        margin: 1.5rem auto;
    }

    .mvaline-card .card-content {
        padding: 20px 20px 5px 20px;
    }
</style>

<div class="card mvaline-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="mvcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/minivaline/MiniValine.js"></script>
<script>
    new MiniValine({
        el: '#mvcomments',
        appId: 'zhM0AOiqle17oPoE84CoYw1e-gzGzoHsz',
        appKey: 'itmzT1JbXfAjVwMqDhGPzU45',
        mode: 'DesertsP',
        placeholder: 'Write a Comment',
        pathname: window.location.pathname,
        lang: '',
        adminEmailMd5: 'de8a7aa53d07e6b6bceb45c64027763d',
        tagMeta: ["管理员", "小伙伴", "访客"],
        master: ["de8a7aa53d07e6b6bceb45c64027763d"],
        friends: ["b5bd5d836c7a0091aa8473e79ed4c25e", "adb7d1cd192658a55c0ad22a3309cecf", "3ce1e6c77b4910f1871106cb30dc62b0", "cfce8dc43725cc14ffcd9fb4892d5bfc"],
        math: true,
        md: true,
        enableQQ: false,
        NoRecordIP: false,
        visitor: true,
        maxNest: 6,
        pageSize: 6,
        serverURLs: '',
        emoticonUrl: ["https://cdn.jsdelivr.net/npm/alus@latest", "https://cdn.jsdelivr.net/gh/MiniValine/qq@latest", "https://cdn.jsdelivr.net/gh/MiniValine/Bilibilis@latest", "https://cdn.jsdelivr.net/gh/MiniValine/tieba@latest", "https://cdn.jsdelivr.net/gh/MiniValine/twemoji@latest", "https://cdn.jsdelivr.net/gh/MiniValine/weibo@latest"],
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09/27/ruan-jian-gong-ju/git-cang-ku-zhong-wen-jian-ming-da-xiao-xie-wen-ti/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Git 仓库中文件名大小写问题">
                        
                        <span class="card-title">Git 仓库中文件名大小写问题</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            关于 git 中的文件名大小写识别问题与解决方法
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="post-category">
                                    软件工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/git-%E5%A4%A7%E5%B0%8F%E5%86%99-ignorecase/">
                        <span class="chip bg-color">git 大小写 ignorecase</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/09/27/ruan-jian-gong-ju/ti-sheng-kai-fa-xiao-lu-de-chrome-kai-fa-zhe-gong-ju-kuai-jie-jian-can-kao/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="提升开发效率的 Chrome 开发者工具快捷键参考">
                        
                        <span class="card-title">提升开发效率的 Chrome 开发者工具快捷键参考</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍与总结 Chrome 浏览器开发者工具(devtool)中的常用快捷键
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-09-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" class="post-category">
                                    软件工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/chrome-devtool-%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7-%E5%BF%AB%E6%8D%B7%E9%94%AE/">
                        <span class="chip bg-color">chrome devtool 开发者工具 快捷键</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('1200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 如梦初醒<br />'
            + '文章作者: kukuqi666<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2018-2024</span>
            
            <span id="year">2018</span>
            <a href="/about" target="_blank">kukuqi666</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">166.9k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2018";
                    var startMonth = "09";
                    var startDate = "20";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/kukuqi666" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:kukuqi666@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100083476812104" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://x.com/wnfng521" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>





    <a href="https://t.me/kukuqi666" class="tooltipped" target="_blank" data-tooltip="关注我的telegram" data-position="top" data-delay="50">
        <i class="fab fa-telegram"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        var searchFunc = function (path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function (xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function () {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function () {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function (data) {
                            var isMatch = true;
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title !== '' && data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i === 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start === 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substr(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                    });

                                    str += "<p class=\"search-result\">" + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        };

        searchFunc('/search.xml', 'searchInput', 'searchResult');
    });
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
